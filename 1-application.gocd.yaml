pipelines:
  Application:
    group: Development

    materials:
      AppGit:
        git: https://github.com/gocd-demo/2016-workshop.git
        branch: add_unit_tests
    stages:
      - build:
          jobs:
            build:
              tasks:
                - exec:
                    command: ./application/build_application.sh
              artifacts:
                - build:
                    source: output
      - unit_test:
          clean_workspace: true
          jobs:
            unit_test:
              artifacts:
                - test:
                    source: report.xml
              tasks:
                - exec:
                    command: eval
                    arguments:
                      - "$(rbenv init -)"
                - exec:
                    command: /bin/bash
                    arguments:
                      - -c
                      - "bundle install"
                - exec:
                    command: /bin/bash
                    arguments:
                      - -c
                      - "ruby unit_test/ruby_test.rb --junit"

      - package:
          jobs:
            package:
              tasks:
                - fetch:
                    stage: build
                    job: build
                    source: output
                - exec:
                    command: ./application/package_application.sh
              artifacts:
                - build:
                    source: installer
