pipelines:
  FunctionalTesting:
    group: Development
    locking: on

    materials:
      services:
        pipeline: Application
        stage: package
      AppGit:
        git: https://github.com/gocd-demo/2016-workshop.git

    stages:
      - DeployApplications:
          clean_workspace: yes
          jobs:
            deploy:
              tasks:
                - exec:
                    command: ./deploy/deploy_application.sh
                    arguments:
                      - FunctionalTesting
      - FunctionalTests:
          clean_workspace: yes
          jobs:
            runTests:
              run_instances: 3
              artifacts:
                - build:
                    source: testoutput
              tasks:
                - exec:
                    command: ./functional_test/functional_test.sh
                    arguments:
                      - FunctionalTests
              tabs:
                report: testoutput/output.txt

  UserAcceptance:
    group: Development

    materials:
      services:
        pipeline: Application
        stage: package
      AppGit:
        git: https://github.com/gocd-demo/2016-workshop.git

    stages:
      - TrafficLight:
          jobs:
            trafficlight:
              tasks:
                - exec:
                    command: echo
                    arguments:
                      - "upstream passed"
      - DeployApplications:
          approval:
            type: success
          jobs:
            deploy:
              tasks:
                - exec:
                    command: ./deploy/deploy_application.sh
                    arguments:
                      - UserAcceptance
      - Approved:
          approval:
            type: success
          jobs:
            approve:
              tasks:
                - exec:
                    command: echo
